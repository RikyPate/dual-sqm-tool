<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<link rel="icon" type="image/x-icon" href="favicon.png">
<title>Lenses Comparison — Dual SQM (tool + guide)</title>
<style>
/* —————–  TEMA DARK PER IL TOOL  —————– */
:root{--fg:#f0f0f0;--bg:#1b1b1b;--border:#444;--accent:#ff914d}
body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--fg);padding:20px;margin:0}
h1{margin-top:0}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid var(--border);padding:6px 8px;text-align:center}
th{background:#2a2a2a}
input[type=number],input[type=text]{width:70px;padding:3px;margin-right:4px}
.flex{display:flex;flex-wrap:wrap;gap:6px;align-items:center;margin-bottom:8px}
canvas{background:#fff;border-radius:6px;max-width:100%}
/* —————–  SEPARATORE  —————– */
hr{border:none;border-top:2px dashed #666;margin:40px 0}
/* —————–  GUIDA (tema chiaro per leggibilità)  —————– */
.guide{background:#ffffff;color:#222;padding:40px;max-width:900px;margin:0 auto;border-radius:6px}
.guide h1,.guide h2,.guide h3{color:#003366;margin-top:1.2em}
.guide table{border-collapse:collapse;width:100%;margin:1em 0}
.guide th,.guide td{border:1px solid #888;padding:6px 8px;text-align:left}
.guide th{background:#f0f0f8}
.guide code{background:#f7f7f7;padding:2px 4px;font-family:Consolas,monospace}
.guide .note{background:#fff8e6;border-left:4px solid var(--accent);padding:8px}
@media(prefers-color-scheme:dark){
  .guide{background:#1e1e1e;color:#ddd}
  .guide th{background:#333}
  .guide table,.guide th,.guide td{border-color:#555}
}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>Confronto Avanzato tra Due Obiettivi — Dual SQM</h1>

<!-- === PARAMETRI GLOBALI =========================================== -->
<div class="flex">
  QE <input id="qe"  type="number" value="60" min="1"  max="100" step="1"> % |
  SQM 1 <input id="sqm1" type="number" value="19.5" step="0.1" min="18" max="22.5"> |
  SQM 2 <input id="sqm2" type="number" value="21"   step="0.1" min="18" max="22.5"> |
  Integrazione (h)&nbsp;<input id="integ" type="number" value="2" step="0.1" min="0.1">
</div>

<!-- === OBIETTIVO A ================================================== -->
<h3>Obiettivo A</h3>
<div class="flex">
  Nome <input id="nameA" type="text" value="Samyang 135 mm" style="width:130px"> f/
  <input id="fA" type="number" value="2" step="0.1" min="1"> |
  T pose (s) <input id="expA" type="number" value="30" step="1" min="1"> |
  Pausa (s) <input id="pauseA" type="number" value="5" step="1" min="0">
</div>

<!-- === OBIETTIVO B ================================================== -->
<h3>Obiettivo B</h3>
<div class="flex">
  Nome <input id="nameB" type="text" value="Takumar 135 mm" style="width:130px"> f/
  <input id="fB" type="number" value="4" step="0.1" min="1"> |
  T pose (s) <input id="expB" type="number" value="60" step="1" min="1"> |
  Pausa (s) <input id="pauseB" type="number" value="10" step="1" min="0">
</div>

<!-- === SCENARIO 1 =================================================== -->
<h2>Scenario 1 — SQM <span id="lblSQM1">19.5</span></h2>
<table>
<thead><tr><th>Parametro</th><th id="colA1">A</th><th id="colB1">B</th></tr></thead>
<tbody id="tbody1"></tbody>
</table>

<!-- === SCENARIO 2 =================================================== -->
<h2>Scenario 2 — SQM <span id="lblSQM2">21</span></h2>
<table>
<thead><tr><th>Parametro</th><th id="colA2">A</th><th id="colB2">B</th></tr></thead>
<tbody id="tbody2"></tbody>
</table>

<!-- === GRAFICO ====================================================== -->
<h2>Grafico «Costo (h) vs SQM» per la lente B</h2>
<canvas id="costChart"></canvas>

<!-- === SCRIPT CORE ================================================== -->
<script>
let chart;   // Chart.js instance

function lightPerPose(f) {
  return 1 / (f * f);
}

function signalPerHour(f, tExp, pause, qe, sky) {
  const light = lightPerPose(f);
  const pauseSafe = Math.max(pause, 1e-6);
  // segnale per posa * pose per ora
  return light * qe * sky * tExp * (3600 / (tExp + pauseSafe));
}

function totalSignal(f, tExp, pause, qe, sky, hours) {
  const n = (hours * 3600) / (tExp + Math.max(pause, 1e-6));
  return n * tExp * lightPerPose(f) * qe * sky;
}

function fmt(val, digits = 2) {
  if (!isFinite(val)) return '—';
  return (+val).toFixed(digits).replace(/\.0+$/, '').replace(/\.$/, '');
}

function update() {
  // Input values
  const qe      = parseFloat(qeInput.value) / 100;
  const sqm1    = parseFloat(sqm1Input.value);
  const sqm2    = parseFloat(sqm2Input.value);
  const H       = parseFloat(integInput.value);

  const fA      = parseFloat(fAInput.value);
  const expA    = parseFloat(expAInput.value);
  const pauseA  = parseFloat(pauseAInput.value);
  const nameA   = nameAInput.value.trim() || 'A';

  const fB      = parseFloat(fBInput.value);
  const expB    = parseFloat(expBInput.value);
  const pauseB  = parseFloat(pauseBInput.value);
  const nameB   = nameBInput.value.trim() || 'B';

  // Aggiorna intestazioni
  colA1.textContent = colA2.textContent = nameA;
  colB1.textContent = colB2.textContent = nameB;
  lblSQM1.textContent = sqm1;
  lblSQM2.textContent = sqm2;

// Fattori cielo (luminosità del cielo, inversamente proporzionale al SQM)
const sky1 = Math.pow(10, -0.4 * (21.75 - sqm1));
const sky2 = Math.pow(10, -0.4 * (21.75 - sqm2));

  // Scenario 1 — totale integrato
  const totA1 = totalSignal(fA, expA, pauseA, qe, sky1, H);
  const totB1 = totalSignal(fB, expB, pauseB, qe, sky1, H);
  const snrA1 = totA1 / Math.sqrt(totA1 + sky1 * (H*3600) / (expA+pauseA));
  const snrB1 = totB1 / Math.sqrt(totB1 + sky1 * (H*3600) / (expB+pauseB));

  const hoursBtoA1 = totA1 / signalPerHour(fB, expB, pauseB, qe, sky1);

  // tabella 1
  tbody1.innerHTML = `
    <tr><td>Luce per posa (1/f²)</td><td>${fmt(lightPerPose(fA),4)}</td><td>${fmt(lightPerPose(fB),4)}</td></tr>
    <tr><td>Pose effettive</td><td>${fmt((H*3600)/(expA+pauseA))}</td><td>${fmt((H*3600)/(expB+pauseB))}</td></tr>
    <tr><td>Segnale totale</td><td>${fmt(totA1)}</td><td>${fmt(totB1)}</td></tr>
    <tr><td>SNR</td><td>${fmt(snrA1)}</td><td>${fmt(snrB1)}</td></tr>
    <tr><td>Ore per uguagliare A</td><td>—</td><td>${fmt(hoursBtoA1)}</td></tr>
    <tr><td>Efficienza vs A</td><td>100 %</td><td>${fmt(100*totB1/totA1)} %</td></tr>`;

  // Scenario 2 — resa per ora
  const sigPerHourA2 = signalPerHour(fA, expA, pauseA, qe, sky2);
  const sigPerHourB2 = signalPerHour(fB, expB, pauseB, qe, sky2);

  const hoursBtoA2 = totA1 / sigPerHourB2; // ore con B @SQM2 per raggiungere segnale A @SQM1

  tbody2.innerHTML = `
    <tr><td>Segnale / h</td><td>${fmt(sigPerHourA2)}</td><td>${fmt(sigPerHourB2)}</td></tr>
    <tr><td>Ore per uguagliare seg. A @ Sc.1</td><td>—</td><td>${fmt(hoursBtoA2)}</td></tr>`;

  // --- Grafico ---
const xs = [];
const ys = [];
for (let s = 18; s <= 22.5; s += 0.1) {
  const sky = Math.pow(10, -0.4 * (21.75 - s));
  const sphB = signalPerHour(fB, expB, pauseB, qe, sky);
  const hNeeded = sphB > 0 ? totA1 / sphB : NaN;
  xs.push(s.toFixed(1));
  ys.push(hNeeded);
}

  if (!chart) {
    const ctx = document.getElementById('costChart').getContext('2d');
    chart = new Chart(ctx, {
      type: 'line',
      data: { labels: xs, datasets: [{ label: 'Ore per uguagliare A (lente B)', data: ys, borderColor: '#ff914d', backgroundColor: 'transparent', pointRadius: 0 }]},
      options: {
        responsive: true,
        scales: {
          y: {
            title: { display: true, text: 'h' },
            suggestedMin: 0,
            ticks: { color: '#ccc' }
          },
          x: {
            title: { display: true, text: 'SQM' },
            ticks: { maxRotation: 0, minRotation: 0, color: '#ccc' }
          }
        },
        plugins: { legend: { labels: { color: '#ccc' } } }
      }
    });
  } else {
    chart.data.labels = xs;
    chart.data.datasets[0].data = ys;
    chart.update();
  }
}

// --- hook inputs ---
const qeInput = document.getElementById('qe');
const sqm1Input = document.getElementById('sqm1');
const sqm2Input = document.getElementById('sqm2');
const integInput = document.getElementById('integ');

const nameAInput = document.getElementById('nameA');
const fAInput = document.getElementById('fA');
const expAInput = document.getElementById('expA');
const pauseAInput = document.getElementById('pauseA');

const nameBInput = document.getElementById('nameB');
const fBInput = document.getElementById('fB');
const expBInput = document.getElementById('expB');
const pauseBInput = document.getElementById('pauseB');

const lblSQM1 = document.getElementById('lblSQM1');
const lblSQM2 = document.getElementById('lblSQM2');
const colA1 = document.getElementById('colA1');
const colB1 = document.getElementById('colB1');
const colA2 = document.getElementById('colA2');
const colB2 = document.getElementById('colB2');
const tbody1 = document.getElementById('tbody1');
const tbody2 = document.getElementById('tbody2');

window.addEventListener('load', () => {
  document.querySelectorAll('input').forEach(inp => {
    inp.addEventListener('input', update);
    inp.addEventListener('change', update);
  });
  update();
});
</script>
</body>
</html>

<!-- ===== SEPARATORE E GUIDA IN CALCE ================================ -->
<hr>
<div class="guide" id="guida">
  <!-- copiato e adattato dalla v5 -->
<h1>Guida Estesa al Tool <em>Confronto Lenti – Dual SQM</em></h1>

<p>Lo scopo di questo semplice tool è stimare <strong>quante ore di integrazione</strong>
sarebbero necessarie con un secondo obiettivo (B) per ottenere lo stesso segnale raccolto
dal primo obiettivo (A) in due diversi scenari di cielo (<abbr title="Sky Quality Meter">SQM</abbr>).</p>

<h2>1&nbsp;&nbsp;Parametri di ingresso</h2>

<table>
<thead><tr><th>Parametro</th><th>Simbolo / Unità</th><th>Significato pratico</th></tr></thead>
<tbody>
<tr><td>Apertura (ob.&nbsp;A/B)</td><td><i>f / #</i></td><td>Rapporto focale; più piccolo ⇒ più luce</td></tr>
<tr><td>Tempo di posa</td><td><i>t</i> [s]</td><td>Durata di un singolo scatto</td></tr>
<tr><td>Pausa tra pose</td><td><i>p</i> [s]</td><td>Tempo morto (download, dithering, ecc.) – può essere 0</td></tr>
<tr><td>Integrazione totale (A)</td><td><i>T</i> [h]</td><td>Ore programmate con l’obiettivo A</td></tr>
<tr><td>QE sensore</td><td>QE [%]</td><td>Efficienza quantica media</td></tr>
<tr><td>SQM 1 &amp; SQM 2</td><td>mag / arcsec²</td><td>18 (città) → 22 (dark-sky)</td></tr>
</tbody>
</table>

<h2>2&nbsp;&nbsp;Modello matematico</h2>

<h3>2.1 Luce per posa</h3>
<pre>L = 1 / (f/#)²</pre>

<h3>2.2 Segnale per ora</h3>
<pre>S<sub>h</sub> = L × QE × sky × t × 3600 / (t + p)</pre>
<ul>
  <li><code>sky = 10<sup>−0.4 × (SQM<sub>ref</sub> − SQM)</sup></code> modella la luminosità del cielo su scala esponenziale.</li>
  <li>Valori di <code>SQM</code> più alti (cielo più buio) → <code>sky</code> più basso → minor rumore di fondo → miglior efficienza.</li>
  <li><code>3600 / (t + p)</code> = quante pose utili entrano in un’ora.</li>
</ul>

<h3>2.3 Segnale totale di&nbsp;A (scenario 1)</h3>
<pre>S<sub>A1</sub> = S<sub>h,A1</sub> × T</pre>

<h3>2.4 Ore con&nbsp;B per uguagliare&nbsp;A</h3>
<pre>
T<sub>B1</sub> = S<sub>A1</sub> / S<sub>h,B1</sub>   (stesso cielo)
T<sub>B2</sub> = S<sub>A1</sub> / S<sub>h,B2</sub>   (SQM diverso)
</pre>

<h2>3&nbsp;&nbsp;Output del tool</h2>
<ul>
<li><strong>Tabelle Scenario 1 / Scenario 2</strong> – luce per posa, pose effettive, segnale,
    SNR, ore per uguagliare A.</li>
<li><strong>Grafico Costo vs SQM</strong> – quante ore (B) servono se il cielo diventa
    via via più buio (SQM ↑).</li>
</ul>

<h2>4&nbsp;&nbsp;Esempio pratico</h2>
<div class="note"><b>Input:</b> A = 135 mm f/2, t = 30 s, p = 5 s, QE = 60 %, SQM 1 = 19.5, T = 2 h<br>
B = 200 mm f/5.6, t = 60 s, p = 10 s</div>
<ul>
<li><b>Stesso cielo</b> → occorrono ≈ 8 h con B.</li>
<li><b>B in SQM = 21</b> → ore necessarie ≈ 5 h.</li>
</ul>

<h2>5&nbsp;&nbsp;Limiti e assunzioni</h2>
<ul>
<li>Non include seeing, vignettatura, filtri, perdite di trasmissione.</li>
<li>Assume regime <em>sky-limited</em> (rumore di fondo dominante).</li>
<li>Il modello usa una scala esponenziale coerente con la definizione fotometrica del SQM.</li>
<li>I risultati sono stime comparative: per progetti critici basarsi su misure reali.</li>
</ul>

<h2>6&nbsp;&nbsp;Consigli rapidi</h2>
<ol>
<li>Imposta <b>Pausa = 0</b> solo se scatti davvero senza dead-time.</li>
<li>Per valutare un cielo migliore, duplica l’obiettivo in A e B,
    lascia identici i parametri di scatto, varia SQM 2 e leggi dal grafico
    quante ore risparmi.</li>
<li>Un campo «—» indica divisione per zero o input non valido.</li>
</ol>

<h2>7&nbsp;&nbsp;Glossario</h2>
<table>
<tr><th>Termine</th><th>Definizione</th></tr>
<tr><td>Segnale</td><td>Elettroni utili accumulati</td></tr>
<tr><td>SNR</td><td>Signal-to-Noise Ratio</td></tr>
<tr><td>SQM</td><td>Sky Quality Meter (mag/arcsec²)</td></tr>
<tr><td>QE</td><td>Quantum Efficiency</td></tr>
<tr><td>Integrazione</td><td>Somma di tutti i tempi di posa utili</td></tr>
</table>

</body>
</html>
